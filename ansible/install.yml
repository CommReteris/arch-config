---
- hosts: all
  become: yes

  pre_tasks:

    - name: temp increase /tmp size
      tags: always
      shell: mount -o remount,size=5G,noatime /tmp

    - name: add sudo conf for aur
      tags: always
      lineinfile:
        path: /etc/sudoers
        line: 'user ALL=(ALL) NOPASSWD: /usr/bin/pacman'

    - name: include boot role for guest
      include_role:
        name: boot
      vars:
        cmdline: resume=/dev/mapper/swap
        cpiomodules: ""
        cpiobinaries: "/usr/bin/btrfs"
        cpiohooks: "base systemd autodetect modconf block sd-vconsole sd-encrypt sd-lvm2 filesystems keyboard resume fsck"
      when: ansible_virtualization_role == "guest"

    - name: include boot role for host
      include_role:
        name: boot
      vars:
        cmdline: resume=/dev/mapper/swap intel_iommu=on iommu=pt vfio-pci.ids=10de:1341
        cpiomodules: "vfio_pci vfio vfio_iommu_type1 vfio_virqfd intel_agp i915"
        cpiobinaries: "/usr/bin/btrfs"
        cpiohooks: "base systemd autodetect modconf block sd-vconsole sd-encrypt sd-lvm2 filesystems keyboard resume fsck"
      when: ansible_virtualization_role == "host"

  roles:
    - { role: pacman, tags: pacman }
    - { role: aur, tags: aur }
    - { role: base, tags: base }
    - { role: desktop, tags: desktop }
    - { role: snapper, tags: snapper }
    - { role: virtualization, tags: virtualization }
    - { role: containers, tags: containers }
    - { role: recovery, tags: recovery }

  tasks:
    - name: Configure root
      user:
        name: root
        shell: /usr/bin/fish

    - name: Configure user
      user:
        name: user
        shell: /usr/bin/fish
        groups: docker,bumblebee,libvirt
        append: yes

  post_tasks:

    - name: tmp size to default
      tags: always
      shell: mount -o remount,noatime /tmp
